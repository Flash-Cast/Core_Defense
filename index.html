<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <title>Asteroids Defense Game</title>
    <style>
        body {
            background-color: #222;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Courier New', sans-serif;
            overflow: hidden;
            /* スクロールバーを消す */
        }

        canvas {
            background-color: #000;
            border: 2px solid #555;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.2);
        }
    </style>
</head>

<body>

    <canvas id="gameCanvas" width="600" height="600"></canvas>

    <script>
        // --- 変数と設定 ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // ゲームの状態 ('start', 'playing', 'gameover')
        let gameState = 'start';
        let score = 0;

        // 中心座標
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        // プレイヤー（壁）の設定
        const wallRadius = 30;
        const wallWidth = 10;

        // 壁の角度（初期値は上を向くように設定: -90度）
        let wallAngle = -Math.PI / 2;

        // 壁の広さ（90度分 = PI/2）
        const wallSize = Math.PI / 1.5;

        // ボール管理
        let balls = [];
        let spawnRate = 60;
        let frameCount = 0;

        // --- イベントリスナー（キーボード操作） ---
        // 押した方向に壁を移動
        document.addEventListener('keydown', (e) => {
            // ゲーム開始・リセット
            if (e.code === 'Space') {
                if (gameState === 'start' || gameState === 'gameover') {
                    resetGame();
                    gameState = 'playing';
                }
                return; // スペースキーのときは壁を動かさない
            }

            // プレイ中のみ操作可能
            if (gameState === 'playing') {
                // 上 (Up / W)
                if (e.code === 'ArrowUp' || e.code === 'KeyW') {
                    wallAngle = -Math.PI / 2;
                }
                // 右 (Right / D)
                else if (e.code === 'ArrowRight' || e.code === 'KeyD') {
                    wallAngle = 0;
                }
                // 下 (Down / S)
                else if (e.code === 'ArrowDown' || e.code === 'KeyS') {
                    wallAngle = Math.PI / 2;
                }
                // 左 (Left / A)
                else if (e.code === 'ArrowLeft' || e.code === 'KeyA') {
                    wallAngle = Math.PI;
                }
            }
        });

        // --- ゲームロジック ---

        function resetGame() {
            score = 0;
            balls = [];
            wallAngle = -Math.PI / 2; // リセット時も上向きに
            spawnRate = 60;
            frameCount = 0;
        }
        // --- ボールクラス（動きのバリエーションを追加） ---
        class Ball {
            constructor() {
                // 3種類の動きをランダムに決定
                // 0: ストレート(赤), 1: スネーク(紫), 2: スパイラル(黄)
                const typeRandom = Math.random();
                if (typeRandom < 0.6) {
                    this.type = 'straight';
                } else if (typeRandom < 0.8) {
                    this.type = 'snake';
                } else {
                    this.type = 'spiral';
                }

                // 基本設定
                const edge = Math.floor(Math.random() * 4);
                const baseSpeed = 2 + (score / 20); // スピード調整

                // 出現位置の決定
                if (edge === 0) { this.x = centerX; this.y = -20; }
                else if (edge === 1) { this.x = canvas.width + 20; this.y = centerY; }
                else if (edge === 2) { this.x = centerX; this.y = canvas.height + 20; }
                else { this.x = -20; this.y = centerY; }

                // 動きの計算用変数
                this.angleToCenter = Math.atan2(centerY - this.y, centerX - this.x);
                this.currentDist = Math.sqrt((this.x - centerX) ** 2 + (this.y - centerY) ** 2);
                this.speed = baseSpeed;
                this.radius = 5;
                this.active = true;
                this.time = 0; // 経過時間（クネクネ計算用）

                // スパイラル用の初期角度
                this.spiralAngle = this.angleToCenter;
            }

            update() {
                this.time += 0.1; // 時間を進める

                // --- 動きのロジック分岐 ---

                if (this.type === 'straight') {
                    // まっすぐ進む
                    this.x += Math.cos(this.angleToCenter) * this.speed;
                    this.y += Math.sin(this.angleToCenter) * this.speed;

                } else if (this.type === 'snake') {
                    // 中心に向かうベクトル
                    const vx = Math.cos(this.angleToCenter) * this.speed;
                    const vy = Math.sin(this.angleToCenter) * this.speed;

                    // 横揺れ（垂直方向のベクトル）を作成
                    // Math.sin(this.time) で揺れを作り、揺れ幅を少しずつ大きくする
                    const wobble = Math.sin(this.time) * 3;

                    // 進行方向に対して垂直な動きを足す (-vy, vx)
                    this.x += vx - (Math.sin(this.angleToCenter) * wobble);
                    this.y += vy + (Math.cos(this.angleToCenter) * wobble);

                } else if (this.type === 'spiral') {
                    // 中心に向かって距離を縮める
                    this.currentDist -= this.speed * 0.8; // 少しゆっくり接近

                    // 角度を回す（距離が近いほど速く回る演出）
                    this.spiralAngle += 0.03;

                    // 極座標(距離と角度)から座標(x,y)に変換
                    this.x = centerX + Math.cos(this.spiralAngle + Math.PI) * this.currentDist;
                    this.y = centerY + Math.sin(this.spiralAngle + Math.PI) * this.currentDist;
                }

                // --- ここから下は共通（当たり判定） ---

                const dx = this.x - centerX;
                const dy = this.y - centerY;
                const dist = Math.sqrt(dx * dx + dy * dy);

                // 1. 壁との衝突判定
                if (dist < wallRadius + wallWidth && dist > wallRadius - wallWidth) {
                    let ballAngle = Math.atan2(dy, dx);
                    let angleDiff = ballAngle - wallAngle;

                    while (angleDiff <= -Math.PI) angleDiff += Math.PI * 2;
                    while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;

                    if (Math.abs(angleDiff) < wallSize / 2) {
                        this.active = false;
                        //一つ当たりの点数
                        score += 10;
                        // 難易度調整
                        if (score % 5 === 0 && spawnRate > 15) spawnRate -= 2;
                    }
                }

                // 2. 中心到達
                if (dist < 10) {
                    gameState = 'gameover';
                }
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);

                // タイプによって色を変える
                if (this.type === 'straight') {
                    ctx.fillStyle = '#ff4444'; // 赤
                } else if (this.type === 'snake') {
                    ctx.fillStyle = '#ff00ff'; // 紫
                } else if (this.type === 'spiral') {
                    ctx.fillStyle = '#ffff00'; // 黄色
                }

                ctx.fill();
                ctx.closePath();
            }
        }

        function update() {
            if (gameState === 'playing') {

                frameCount++;
                if (frameCount % spawnRate === 0) {
                    balls.push(new Ball());
                }

                balls.forEach(ball => ball.update());
                balls = balls.filter(ball => ball.active);
            }
        }

        function draw() {
            // 残像効果
            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 中心
            ctx.beginPath();
            ctx.arc(centerX, centerY, 15, 0, Math.PI * 2);
            // ゲームオーバーなら赤、それ以外は青
            if (gameState === 'gameover') {
                ctx.fillStyle = '#ff0000'; // 赤 (被弾！)
            } else {
                ctx.fillStyle = '#00ffff'; // 青 (通常)
            }
            ctx.fill();
            ctx.closePath();

            // プレイヤーの壁
            ctx.beginPath();
            ctx.arc(centerX, centerY, wallRadius, wallAngle - wallSize / 2, wallAngle + wallSize / 2);
            ctx.strokeStyle = '#00ff00';
            ctx.lineWidth = wallWidth;
            ctx.stroke();
            ctx.closePath();

            // ガイド線（今の方向をわかりやすくするため、薄く表示）
            ctx.beginPath();
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(centerX + Math.cos(wallAngle) * (wallRadius - 10), centerY + Math.sin(wallAngle) * (wallRadius - 10));
            ctx.strokeStyle = 'rgba(0, 255, 0, 0.3)';
            ctx.lineWidth = 2;
            ctx.stroke();


            if (gameState === 'playing' || gameState === 'gameover') {
                balls.forEach(ball => ball.draw());
            }

            // テキスト表示
            ctx.fillStyle = 'white';
            ctx.textAlign = 'left';
            ctx.font = '20px Courier New';
            ctx.fillText(`SCORE: ${score}`, 20, 30);

            ctx.textAlign = 'center';
            if (gameState === 'start') {
                ctx.font = '40px Courier New';
                ctx.fillText("CORE DEFENSE", centerX, centerY - 50);
                ctx.font = '20px Courier New';
                ctx.fillText("PRESS SPACE TO START", centerX, centerY + 50);
                ctx.fillText("Use Arrow Keys or WASD", centerX, centerY + 80);
            } else if (gameState === 'gameover') {
                ctx.fillStyle = 'red';
                ctx.font = '40px Courier New';
                ctx.fillText("GAME OVER", centerX, centerY - 50);
                ctx.fillStyle = 'white';
                ctx.font = '20px Courier New';
                ctx.fillText(`RESULT SCORE: ${score}`, centerX, centerY + 20);
                ctx.fillText("PRESS SPACE TO RETRY", centerX, centerY + 60);
            }
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        gameLoop();
    </script>
</body>

</html>